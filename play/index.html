<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | bakk1</title>
    <script src="sbecky.js" charset="utf-8"></script>
    <script src="Build/UnityLoader.js"></script>
    <script src="Chart.min.js" charset="utf-8"></script>

    <style media="screen" id="style">
        * {
            font-family: monospace;
        }

        body {
            background: #f9f9f9;
        }

        #gamewrapper {
            width: 70%;
            position: relative;
            height: 100%;
            float: left;
            box-sizing: border-box;
        }

        #gameContainer {
            background: #aaa;
            width: 100% !important;
            height: auto !important;
        }

        #gameContainer canvas {
            width: 100% !important;
            height: auto !important;
        }

        #sidebar {
            width: 29.4%;
            float: right;
            background: #fff;

            border: 2pt solid #111;
            /* padding: 0.25rem 0.5rem; */
            /* border-radius: 4pt; */
            box-sizing: border-box;
        }

        #sidebar label {
            font-family: monospace;
            height: 2rem;
            line-height: 2rem;
        }

        #sidebar input,
        #sidebar label {
            /* width: 50%; */
            display: inline-block;
            /* background: #eee; */
            box-sizing: border-box;
            height: 2rem;
            line-height: 2rem;
            float: left;
            margin: 0;
        }

        #sidebar label:nth-child(2) {
            float: right;
        }

        #sidebar .line label:first-of-type span {
            float: right;
            margin-right: 1rem;
        }

        .slider {
            border-bottom: 2pt solid #111;
            padding: 0.5rem 0.65rem;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #history {
            box-sizing: border-box;
            width: 70%;
            float: left;
        }

        #history .item {
            /* background: #f9f9f9; */
            border: 2pt solid #111;
            position: relative;
            /* height: 19rem; */
            overflow: hidden;
            margin-top: 0.5rem;
        }

        #history .item>div:first-of-type {
            /* height: 3rem;
            line-height: 3rem; */
            /* background: #fff; */
            border-bottom: 2pt solid #111;
            width: 100%;
            display: block;
            padding: 0 0.69rem;
        }

        #history .item>div a:first-of-type {
            margin-left: 0.69rem;
        }

        #history .item>div:nth-of-type(2) {
            display: block;
            overflow: hidden;
            position: relative;
            height: 20rem;
        }

        #history .item pre {
            width: 100%;
            font-family: monospace;
            background: none;
            border: none;
            padding: 0 0.3rem;
        }

        #history .hist-chart {
            position: absolute;
            height: 100%;
            right: 0.69rem;
            top: 0;
        }

        .bar-controls {
            display: inline-block;
            padding-top: 0.5rem;
        }

        .controls {
            border-bottom: 2pt solid #111;
            padding: 0.5rem 0.65rem;
        }

        .controls .desc {
            color: #bbb;
            font-size: 12px;
            display: none;
        }

        a {
            display: inline-block;
            background: #ccc;
            padding: 0.5rem 0.67rem;
            margin: 0.25rem 0;
            text-decoration: none;
            color: #000;
            /* border-radius: 99rem; */
        }

        a:hover {
            transition: 0.2s all ease;
            background: #ccc;
            /* margin-top: -5px;
            margin-bottom: 5px; */
        }

        .select {
            background: rgba(255, 80, 90, 0.6) !important;
        }

        .select:hover {
            background: rgba(255, 80, 90, 0.8) !important;
        }

        .header {
            margin-top: -0.5rem;
        }

        .header h2 {
            height: 1rem;
            font-size: 1rem;
            color: inherit;
            font-weight: normal;
            color: #111;
            text-transform: uppercase;
            margin-bottom: 0.75rem;
        }

        .line>*:nth-child(1) {
            width: 60%;
        }

        .line>*:nth-child(2) {
            width: 40%;
        }

        .line,
        .speed {
            overflow: hidden;
        }

        .speed input[type="range"] {
            width: 100%;
        }

        #rating-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 10;
            padding: 10vw 0;
            box-sizing: border-box;
            text-align: center;
        }

        #rating-popup>* {
            font-size: 24px;
            width: 700px;
            margin: 0 auto;
        }

        #rating-popup p {
            padding: 0.5rem;
            box-sizing: border-box;
            margin-bottom: 3rem;
        }

        #rating-popup .rating-controls {
            padding: 0.5rem;
            box-sizing: border-box;
            margin-top: 3.5rem;
            text-align: center;
        }

        #rating-popup .rating-controls>input {
            background: #000;
            color: #fff;
            text-decoration: none;
            padding: 0.5rem;
            transition: 0.15s all ease;
            margin: 0 auto;
            -webkit-appearance: none;
            border: none;
            font-size: inherit;
            cursor: pointer;
        }

        #rating-popup .rating-controls>input:hover {
            transition: 0.15s all ease;
            background: #222;
        }

        .rating-item {
            text-align: left;
            padding: 0.5rem 0;
            max-width: 100%;
        }

        .rating-item label {
            font-size: 24px;
        }

        .rating {
            float: right;
        }

        .rating .rating-line {
            position: relative;
            width: 18rem;
        }

        .rating .rating-line input {
            position: absolute;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0;
        }

        .rating .rating-line .rating-stars {
            top: 0;
            left: 0;
            width: 100%;
            height: 3rem;
            pointer-events: none;
            fill: gray;
        }

        .rating .rating-line .rating-stars .rating-star {
            width: calc(100%/5);
            float: left;
            height: 100%;
            box-sizing: border-box;
        }

        .rating .rating-line .rating-stars .rating-star:first-of-type {
            fill: gold;
        }

        .rating .rating-line .rating-stars .rating-star>* {
            height: 100%;
            width: 100%;
        }

        .rating .rating-line .rating-stars .rating-star>*>* {
            height: 100%;
        }

    </style>

</head>

<body>
    <div class="wrapper">
        <div id="gamewrapper">
            <div id="gameContainer" style="width: 400px; height: 300px; margin: auto"></div>
        </div>
        <div id="sidebar">
            <div class="controls">
                <div class="header">
                    <h2>Play mode</h2>
                </div>
            </div>
            <div class="slider" >
                <div class="line">
                    <label for="">Play<span sb-bind="p_flat"></span></label>
                    <input type="range" name="" value="" sb-bind="p_flat" min="0" max="1" step="0.1" value="0.4">
                </div>

                <div class="line">
                    <label for="">P(hole):<span sb-bind="p_hole"></span></label>
                    <input type="range" name="" value="" sb-bind="p_hole" min="0" max="1" step="0.1" value="0.3">

                </div>

                <div class="line">
                    <label for="">P(obstacle):<span sb-bind="p_obstacle"></span></label>
                    <input type="range" name="" value="" sb-bind="p_obstacle" min="0" max="1" step="0.1" value="0.3">

                </div>

                <div class="line">
                    <label for="">P(f)+P(h)+P(o)</label>
                    <label for="" sb-bind="p_sum"></label>
                </div>

                <div class="line">
                    <label for="">Speed: <span sb-bind="speed"></span></label>
                    <input type="range" name="" value="" sb-bind="speed" min="5" max="20" step="0.1" value="5">
                </div>

                <div class="line">
                    <label for="">Force: <span sb-bind="force"></span></label>
                    <input type="range" name="" value="" sb-bind="force" min="4" max="20" step="0.1" value="4">
                </div>

                <div class="line">
                    <label for="">Gravity: <span sb-bind="gravity"></span></label>
                    <input type="range" name="" value="" sb-bind="gravity" min="0.6" max="3.6" step="0.1" value="1">
                </div>

                <div class="line">
                    <label for="">Obst.height: <span sb-bind="obst_height"></span></label>
                    <input type="range" name="" value="" sb-bind="obst_height" min="1" max="10" step="1" value="1">
                </div>

                <div class="line">
                    <label for="">Block length: <span sb-bind="block_length"></span></label>
                    <input type="range" name="" value="" sb-bind="block_length" min="1" max="25" step="1" value="5">
                </div>

                <div class="line">
                    <label for="">Seed: <span sb-bind="seed">0</span></label>
                    <input type="text" name="" value="" sb-bind="seed">
                </div>

                <div class="line">
                    <label for="">Score:</label>
                    <label for=""><span sb-bind="score"></span></label>
                </div>

                <div class="line">
                    <label for="">Difficulty:</label>
                    <label for=""><span sb-bind="score_scaled_label"></span></label>
                </div>

                <div class="line">
                    <label for="">Players:</label>
                    <label for=""><span sb-bind="players"></span>/<span sb-bind="max_players"></span></label>
                </div>

                <div class="line">
                    <label for="">Max Players: <span sb-bind="max_players"></span></label>
                    <input type="range" sb-bind="max_players" min="1" max="100" step="1" value="100">
                </div>
            </div>
            <!-- <div class="controls">
                <a href="javascript:void(0)" onclick="kill()">Generate new level</a>
                <a href="javascript:void(0)" onclick="importLevel()">Import Level</a>
            </div> -->
            <!-- <canvas id="chart" width="100" height="100"></canvas> -->
        </div>
        <!-- <div style="clear:both;"></div> -->
        <!-- <div class="bar-controls">
            <a href="javascript:void(0)" onclick="document.getElementById('history').innerHTML = ''">Delete all</a>
            <a href="javascript:void(0)" onclick="exportAll(this)" download="history.html">Export all as HTML</a>
            <a href="javascript:void(0)" onclick="alert('todo')" download="history.txt">Export all as JSON</a>
        </div> -->
    </div>

    <form class="rating-popup" id="rating-popup" sb-form="rating" method="post" action="http://rokity.com/webgl/rate.php">
        <p>Game over! ☠︎</p>
        <p>How was the game? bla bla bla</p>
        <div class="rating-item">
            <label>Difficulty</label>
            <div sb-form="rating" class="rating">
                <div class="rating-line">
                    <div class="rating-stars">
                        <div class="rating-star">
                            <svg viewBox="0 0 15 23" height="25" width="23" class="star rating" data-rating="2">
                                <polygon points="9.9, 1.1, 3.3, 21.78, 19.8, 8.58, 0, 8.58, 16.5, 21.78" style="fill-rule:nonzero;"/>
                            </svg>
                        </div>
                        <div class="rating-star">
                            <svg viewBox="0 0 15 23" height="25" width="23" class="star rating" data-rating="2">
                                <polygon points="9.9, 1.1, 3.3, 21.78, 19.8, 8.58, 0, 8.58, 16.5, 21.78" style="fill-rule:nonzero;"/>
                            </svg>
                        </div>
                        <div class="rating-star">
                            <svg viewBox="0 0 15 23" height="25" width="23" class="star rating" data-rating="2">
                                <polygon points="9.9, 1.1, 3.3, 21.78, 19.8, 8.58, 0, 8.58, 16.5, 21.78" style="fill-rule:nonzero;"/>
                            </svg>
                        </div>
                        <div class="rating-star">
                            <svg viewBox="0 0 15 23" height="25" width="23" class="star rating" data-rating="2">
                                <polygon points="9.9, 1.1, 3.3, 21.78, 19.8, 8.58, 0, 8.58, 16.5, 21.78" style="fill-rule:nonzero;"/>
                            </svg>
                        </div>
                        <div class="rating-star">
                            <svg viewBox="0 0 15 23" height="25" width="23" class="star rating" data-rating="2">
                                <polygon points="9.9, 1.1, 3.3, 21.78, 19.8, 8.58, 0, 8.58, 16.5, 21.78" style="fill-rule:nonzero;"/>
                            </svg>
                        </div>

                    </div>
                    <input type="range" min="1" max="5" name="" value="1" sb-bind="slider1" name="difficulty">
                </div>
            </div>
        </div>
        <div class="rating-item">
            <label>Fun factor</label>
            <div sb-form="rating" class="rating">
                <div class="rating-line">
                    <div class="rating-stars">
                        <div class="rating-star">
                            <svg viewBox="0 0 15 23" height="25" width="23" class="star rating" data-rating="2">
                                <polygon points="9.9, 1.1, 3.3, 21.78, 19.8, 8.58, 0, 8.58, 16.5, 21.78" style="fill-rule:nonzero;"/>
                            </svg>
                        </div>
                        <div class="rating-star">
                            <svg viewBox="0 0 15 23" height="25" width="23" class="star rating" data-rating="2">
                                <polygon points="9.9, 1.1, 3.3, 21.78, 19.8, 8.58, 0, 8.58, 16.5, 21.78" style="fill-rule:nonzero;"/>
                            </svg>
                        </div>
                        <div class="rating-star">
                            <svg viewBox="0 0 15 23" height="25" width="23" class="star rating" data-rating="2">
                                <polygon points="9.9, 1.1, 3.3, 21.78, 19.8, 8.58, 0, 8.58, 16.5, 21.78" style="fill-rule:nonzero;"/>
                            </svg>
                        </div>
                        <div class="rating-star">
                            <svg viewBox="0 0 15 23" height="25" width="23" class="star rating" data-rating="2">
                                <polygon points="9.9, 1.1, 3.3, 21.78, 19.8, 8.58, 0, 8.58, 16.5, 21.78" style="fill-rule:nonzero;"/>
                            </svg>
                        </div>
                        <div class="rating-star">
                            <svg viewBox="0 0 15 23" height="25" width="23" class="star rating" data-rating="2">
                                <polygon points="9.9, 1.1, 3.3, 21.78, 19.8, 8.58, 0, 8.58, 16.5, 21.78" style="fill-rule:nonzero;"/>
                            </svg>
                        </div>

                    </div>
                    <input type="range" min="1" max="5" name="" value="1" sb-bind="slider2" name="rating">
                </div>
            </div>
            <input type="hidden" name="score" sb-bind="score_scaled">
            <input type="hidden" name="user" sb-bind="user">
            <div class="rating-controls">
                <input type="submit" name="" value="Play again">
            </div>
        </div>


        <script type="text/javascript">
            sbecky_ready(function () {
                var sliders = ["slider1", "slider2"]
                for (var i in sliders) {
                    if (sliders.hasOwnProperty(i)) {
                        var _slider = sliders[i];
                        (function(slider){
                            sbecky_onchange(slider, function(val) {
                                var parent = sbecky_get(slider)[0].parentNode
                                var stars = parent.getElementsByClassName("rating-star");
                                for (var i in stars) {
                                    if (stars.hasOwnProperty(i)) {
                                        if (i < val) {
                                            stars[i].style.fill = "gold";
                                        }else{
                                            stars[i].style.fill = "gray";
                                        }
                                    }
                                }
                            })
                        })(_slider)
                    }
                }
            });

            sbecky_onresponse("rating", function(e){

                // TODO: show thank you popup
                console.log("response", e);

                document.getElementById("rating-popup").style.display = "none";
                gameInstance.SendMessage('Simulation', 'start_game')
                gameInstance.SendMessage('Simulation', 'remove_dead')
            });

            sbecky_onsubmit("rating", function(e){

                console.log("submit", e);

                // document.getElementById("rating-popup").style.display = "none";
                // gameInstance.SendMessage('Simulation', 'start_game')
                // gameInstance.SendMessage('Simulation', 'remove_dead')
            });
        </script>
    </form>

    <script>
        gameInstance = UnityLoader.instantiate("gameContainer", "Build/play.json");

        // var ctx = document.getElementById("chart").getContext('2d');
        // var chart = new Chart(ctx, {
        //     type: 'line',
        //     data: {
        //         labels: [],
        //         datasets: [{
        //             label: '# of alive player',
        //             data: [],
        //             backgroundColor: [
        //                 'rgba(255, 80, 90, 0.6)'
        //             ],
        //             pointRadius: 0,
        //             lineTension: 0
        //         }]
        //     },
        //     options: {
        //         scales: {
        //             yAxes: [{
        //                 ticks: {
        //                     beginAtZero: true,
        //                     fontSize: 14
        //                 }
        //             }],
        //             xAxes: [{
        //                 ticks: {
        //                     fontSize: 14
        //                 }
        //             }]
        //         },
        //         animation: false
        //     }
        // });

        function init() {

            pause()

            console.log("init");
            ajax("http://rokity.com/webgl/getplayed.php?game=true", "POST", {"game":"true"}, function(json){
                console.log(json);
                if(getCookie("player") == null) {
                    setCookie("player", Math.floor((Math.random() * Math.pow(2, 10)) + 1), 99)
                }

                sbecky.player = getCookie("player")

                setTimeout(function(){
                    importLevel(json)
                    play()
                    kill()
                }, 100)

            }, function(err) {
                console.log("play not called error:", err);
            })
        }

        function end() {
            document.getElementById("rating-popup").style.display = "block";
        }

        // setCookie & getCookie taken from https://stackoverflow.com/a/24103596
        function setCookie(name,value,days) {
            var expires = "";
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days*24*60*60*1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/";
        }
        function getCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for(var i=0;i < ca.length;i++) {
                var c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }
        function eraseCookie(name) {
            document.cookie = name+'=; Max-Age=-99999999;';
        }

        function updateChart(data) {
            return
        }

        function custom(wat) {
            return
        }

        function save() {
            var s = sbecky.p_flat + ";" + sbecky.p_hole + ";" + sbecky.p_obstacle + ";" + sbecky.obst_height +
                ";" + sbecky.speed + ";" + sbecky.force + ";" + sbecky.gravity + ";" + sbecky.block_length +
                ";" + sbecky.seed + ";" + sbecky.players
            gameInstance.SendMessage('Simulation', 'setParams', s)
        }

        function set(id) {
            // custom(document.getElementById("custom-button"));
            gameInstance.SendMessage('Simulation', 'setParams', sbecky["hist_" + id])
            kill()
        }

        function remove(id, el) {
            el.parentNode.parentNode.parentNode.removeChild(el.parentNode.parentNode);
        }

        function clip(el) {
            var pre = el.parentNode.parentNode.children[1].children[0];
            pre.select();
            document.execCommand("Copy");
        }

        function setSeed(value) {
            // custom(document.getElementById("custom-button"));
            save()
            gameInstance.SendMessage('Simulation', 'setSeed', "" + value)
            kill()
        }

        function kill(save = false) {
            gameInstance.SendMessage('Simulation', 'restart', "" + save)
        }

        function slower() {
            gameInstance.SendMessage('Simulation', 'slower')
        }

        function normal() {
            gameInstance.SendMessage('Simulation', 'resetTime')
        }

        function pause() {
            gameInstance.SendMessage('Simulation', 'pause')
        }

        function faster() {
            gameInstance.SendMessage('Simulation', 'faster')
        }

        function setSimulationSpeed(val) {
            gameInstance.SendMessage('Simulation', 'setSimulationSpeed', val + "")
        }

        function selectButton(el) {
            var ch = el.parentNode.children
            for (let i = 0; i < ch.length; i++) {
                const element = ch[i];
                element.classList.remove("select")
            }
            el.classList.add("select")
        }


        function play(el) {
            // selectButton(el)
            // bindings[0]["play_desc"][0].style.display = "block";
            gameInstance.SendMessage('Simulation', 'playmode');
            kill();
        }

        function importLevel(s) {

            // var s = prompt("Please paste the level json", "");

            if (s != null && s != "") {

                var json = JSON.parse(s);

                _sbecky_sould_call_change = false

                sbecky.p_flat = json["p_flat"]
                sbecky.p_hole = json["p_hole"]
                sbecky.p_obstacle = json["p_obstacle"]
                sbecky.speed = json["speed"]
                sbecky.force = json["force"]
                sbecky.gravity = json["gravity"]
                sbecky.obst_height = json["obst_height"]
                sbecky.block_length = json["block_length"]
                sbecky.seed = json["seed"]
                sbecky.max_players = json["max_players"]

                _sbecky_sould_call_change = true
            }
        }

        // sbecky_change("speed", function(val) {
        //     if (val.length > 0) {
        //         // gameInstance.SendMessage('Simulation', 'setSpeed', ""+sbecky.speed);
        //         custom(document.getElementById("custom-button"));
        //         save()
        //     }
        // })
        //
        // sbecky_change("force", function(val) {
        //     if (val.length > 0) {
        //         // gameInstance.SendMessage('Simulation', 'setForce', ""+sbecky.force);
        //         custom(document.getElementById("custom-button"));
        //         save()
        //     }
        // })
        //
        // sbecky_change("gravity", function(val) {
        //     if (val.length > 0) {
        //         // gameInstance.SendMessage('Simulation', 'setGravity', ""+sbecky.gravity);
        //         custom(document.getElementById("custom-button"));
        //         save()
        //     }
        // })
        //
        // sbecky_change("block_length", function(val) {
        //     if (val.length > 0) {
        //         custom(document.getElementById("custom-button"));
        //         save()
        //     }
        // })
        //
        // sbecky_change("max_players", function(val) {
        //     if (val.length > 0) {
        //         gameInstance.SendMessage('Simulation', 'setPlayers', "" + sbecky["max_players"]);
        //         kill()
        //     }
        // })
        //
        // sbecky_change("obst_height", function(val) {
        //     if (val.length > 0) {
        //         custom(document.getElementById("custom-button"));
        //         save()
        //     }
        // })
        //
        //
        // sbecky_change("seed", function(to) {
        //     if (to.length > 0) {
        //         save()
        //         custom(document.getElementById("custom-button"));
        //         kill()
        //     }
        // })
        //
        // sbecky_change("sim_speed", function(to) {
        //     if (to.length > 0 && should_set_time_slider) {
        //         console.log("set", to);
        //         gameInstance.SendMessage('Simulation', 'setSimulationSpeed', to)
        //         sbecky.time = to
        //     }
        // })

        function set_p_sum() {
            sbecky.p_sum = parseFloat(sbecky.p_flat) + parseFloat(sbecky.p_hole) + parseFloat(sbecky.p_obstacle)
            if (sbecky.p_sum > 0.99999 && sbecky.p_sum < 1.00001) {
                bindings[0]["p_sum"][0].style.color = "black";
                bindings[0]["p_sum"][0].style.backgroundColor = "white";
                sbecky.p_sum = sbecky.p_sum.toPrecision(2);
                if (should_set_p) {
                    gameInstance.SendMessage('Simulation', 'setProbabilities', sbecky.p_flat + ";" + sbecky.p_hole + ";" + sbecky.p_obstacle);
                    // custom(document.getElementById("custom-button"));
                    kill()
                }
            } else {
                sbecky.p_sum = sbecky.p_sum.toPrecision(2);
                bindings[0]["p_sum"][0].style.color = "white";
                bindings[0]["p_sum"][0].style.backgroundColor = "red";
            }
        }

        sbecky_change("p_flat", function(to) {
            set_p_sum()
        })

        sbecky_change("p_hole", function(to) {
            set_p_sum()
        })

        sbecky_change("p_obstacle", function(to) {
            set_p_sum()
        })

        // function exportAll(a) {
        //     var c = document.getElementById("history").outerHTML;
        //
        //     var style = document.getElementById("style").outerHTML;
        //     var file = "<html><head>" + style + "</head><body>" + c + "</body></html>"
        //     file = btoa(file)
        //     a.href = "data:application/octet-stream;charset=utf-16le;base64," + file
        // }
    </script>
</body>

</html>
